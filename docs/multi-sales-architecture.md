# Архитектура для трех типов продаж

## Три типа продаж:

1. **Smart Food** - доставка на следующий день, собственный билдер
2. **Mercat** - ~10 позиций, готово всегда, день в день, можно отдельно или как добавление
3. **Glovo/Uber** - Smart Food через сторонние площадки, день в день, только ссылки

## Рекомендуемая архитектура:

### Вариант 1: Единая корзина с разделением (РЕКОМЕНДУЕТСЯ)

**Структура:**
- **1 страница меню** с табами/секциями для каждого типа
- **1 корзина WooCommerce** (единая)
- **3 разных продукта WooCommerce** (по одному на каждый тип)
- **Метаданные в корзине** для различения типов

**Преимущества:**
- ✅ Пользователь может добавить Smart Food, потом Mercat, потом еще Smart Food
- ✅ Одна корзина - проще для пользователя
- ✅ Легко анализировать (по product_id или метаданным)
- ✅ Простое управление заказами

**Реализация:**

#### 1. WooCommerce продукты:
- **Product ID 44** - Smart Food (уже есть)
- **Product ID XX** - Mercat (создать новый виртуальный продукт)
- **Product ID YY** - Glovo/Uber (создать новый виртуальный продукт, но не используется в корзине)

#### 2. Структура страниц:
```
/menu/ - Главная страница меню
  ├─ Таб "Smart Food" (текущий билдер)
  ├─ Таб "Mercat" (новый билдер, ~10 позиций)
  └─ Секция "Glovo/Uber" (список с ссылками)
```

#### 3. Корзина:
- Единая корзина WooCommerce
- В метаданных каждого товара сохраняем:
  - `order_type`: 'smart_food' | 'mercat' | 'glovo' | 'uber'
  - `delivery_type`: 'next_day' | 'same_day' | 'external'
  - `source`: 'smart_food_builder' | 'mercat_builder' | 'external_link'

#### 4. Checkout:
- При оформлении заказа показываем разделение по типам
- Разные опции доставки в зависимости от типа
- В заказе сохраняем метаданные для аналитики

---

### Вариант 2: Раздельные корзины (НЕ РЕКОМЕНДУЕТСЯ)

**Проблемы:**
- ❌ Сложнее для пользователя (две корзины)
- ❌ Невозможно смешивать заказы
- ❌ Сложнее аналитика
- ❌ Больше кода для поддержки

---

## Рекомендуемая реализация (Вариант 1):

### Структура файлов:

```
weekly-meal-builder/
  ├─ weekly-meal-builder.php (Smart Food)
  ├─ mercat-builder.php (новый плагин для Mercat)
  └─ assets/
      ├─ wmb.js (Smart Food)
      ├─ wmb.css (Smart Food)
      ├─ mercat.js (Mercat)
      └─ mercat.css (Mercat)
```

### Или один плагин с модулями:

```
weekly-meal-builder/
  ├─ weekly-meal-builder.php (основной)
  ├─ includes/
  │   ├─ smart-food.php
  │   ├─ mercat.php
  │   └─ glovo-uber.php
  └─ assets/
      ├─ smart-food.js
      ├─ mercat.js
      └─ shared.css
```

### Страницы WordPress:

1. **`/menu/`** - Главная страница с табами:
   - Таб "Smart Food" → `[meal_builder]` (текущий шорткод)
   - Таб "Mercat" → `[mercat_builder]` (новый шорткод)
   - Секция "Заказать через Glovo/Uber" → список ссылок

2. **`/cart/`** - Единая корзина (стандартная WooCommerce)

3. **`/checkout/`** - Оформление заказа (стандартная WooCommerce)

### Метаданные в корзине:

```php
// При добавлении Smart Food
$cart_item_data = [
  'wmb_payload' => json_encode($payload),
  'order_type' => 'smart_food',
  'delivery_type' => 'next_day',
  'source' => 'smart_food_builder'
];

// При добавлении Mercat
$cart_item_data = [
  'mercat_payload' => json_encode($mercat_payload),
  'order_type' => 'mercat',
  'delivery_type' => 'same_day',
  'source' => 'mercat_builder'
];
```

### Отображение в корзине:

```php
// В корзине группируем по типам:
// ┌─────────────────────────────┐
// │ Smart Food                  │
// │ - Блюдо 1 × 2              │
// │ - Блюдо 2 × 1              │
// │ Доставка: завтра           │
// └─────────────────────────────┘
// ┌─────────────────────────────┐
// │ Mercat                      │
// │ - Позиция 1 × 1            │
// │ Доставка: сегодня           │
// └─────────────────────────────┘
```

### Аналитика и заказы:

В метаданных заказа сохраняем:
```php
$order->update_meta_data('_order_types', [
  'smart_food' => true,
  'mercat' => true
]);
$order->update_meta_data('_delivery_types', [
  'next_day' => true,
  'same_day' => true
]);
```

---

## UI/UX предложения:

### Главная страница `/menu/`:

```
┌─────────────────────────────────────────┐
│ [Smart Food] [Mercat] [Glovo/Uber]     │ ← Табы
├─────────────────────────────────────────┤
│                                         │
│  [Контент выбранного таба]              │
│                                         │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│ Корзина (общая)                         │
│ Smart Food: 3 порции                     │
│ Mercat: 1 позиция                       │
│ Итого: 45.00€                           │
│ [Перейти к оформлению]                  │
└─────────────────────────────────────────┘
```

### Или вертикальные секции:

```
┌─────────────────────────────────────────┐
│ Smart Food                               │
│ [текущий билдер]                        │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│ Mercat                                   │
│ [билдер с ~10 позициями]                │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│ Заказать через Glovo/Uber                │
│ [Ссылки на внешние площадки]            │
└─────────────────────────────────────────┘
```

---

## Технические детали:

### 1. Mercat Builder:

**Отличия от Smart Food:**
- Нет дедлайнов доставки
- Нет категорий (или одна категория)
- Проще интерфейс
- Меньше позиций (~10)
- Всегда доступно (нет фильтра "активно")

**Структура:**
- Отдельный CPT: `mercat_item` (или использовать `wmb_dish` с мета-полем `sale_type`)
- Отдельный REST API endpoint: `/wmb/v1/mercat`
- Отдельный JS файл: `mercat.js`
- Общий CSS (можно переиспользовать)

### 2. Glovo/Uber:

**Просто список:**
- Статическая HTML секция или
- Отдельный шорткод `[glovo_uber_links]`
- Список блюд с ссылками на внешние площадки
- Можно хранить ссылки в мета-полях блюд или отдельной таблице

### 3. Единая корзина:

**Логика:**
- Оба билдера добавляют в одну корзину WooCommerce
- Разные product_id для различения типов
- В метаданных сохраняем тип заказа
- При оформлении показываем разделение

---

## Рекомендации:

### ✅ РЕКОМЕНДУЕТСЯ:

1. **Единая корзина** - проще для пользователя
2. **Табы на одной странице** - навигация понятнее
3. **Метаданные в корзине** - для аналитики и различения
4. **Переиспользование кода** - общие функции для обоих билдеров
5. **Отдельные product_id** - для различения в WooCommerce

### ❌ НЕ РЕКОМЕНДУЕТСЯ:

1. Раздельные корзины - сложнее UX
2. Разные страницы для каждого типа - лишние переходы
3. Дублирование кода - сложнее поддерживать

---

## План реализации:

### Этап 1: Подготовка
1. Создать новые WooCommerce продукты (Mercat, Glovo/Uber)
2. Добавить мета-поле `sale_type` к блюдам (smart_food/mercat/glovo/uber)
3. Обновить структуру данных

### Этап 2: Mercat Builder
1. Создать новый шорткод `[mercat_builder]`
2. Адаптировать текущий билдер для Mercat (упростить)
3. Добавить в корзину с метаданными

### Этап 3: Glovo/Uber секция
1. Создать шорткод `[glovo_uber_links]`
2. Добавить поля для ссылок в админку
3. Отобразить список с ссылками

### Этап 4: UI объединение
1. Создать страницу `/menu/` с табами
2. Интегрировать все три секции
3. Обновить корзину для показа разделения

### Этап 5: Checkout и аналитика
1. Обновить checkout для разделения типов
2. Добавить метаданные в заказы
3. Обновить аналитику для различения типов

---

## Вопросы для уточнения:

1. Mercat - это те же блюда что Smart Food или совсем другие?
2. Glovo/Uber - это все блюда Smart Food или только часть?
3. Нужна ли возможность заказать Mercat отдельно (без Smart Food)?
4. Как должна выглядеть доставка при смешанном заказе (Smart Food + Mercat)?

