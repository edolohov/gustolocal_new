-- SQL скрипт для исправления проблемы со сканированием Wordfence
-- 
-- Проблема: INSERT query failed для таблицы wffilemods
-- Причина: Слишком длинный запрос или маленький max_allowed_packet
--
-- ИСПОЛЬЗОВАНИЕ:
-- 1. Откройте phpMyAdmin
-- 2. Выберите базу данных u850527203_5vYEq
-- 3. Перейдите на вкладку "SQL"
-- 4. Скопируйте и выполните запросы ниже
-- 
-- ВАЖНО: Замените wp_ на ваш реальный префикс таблиц (stg_ или wp_)
-- Проверьте имя таблицы через диагностический скрипт: fix-wordfence-scan.php

-- ============================================
-- ШАГ 1: Увеличить max_allowed_packet
-- ============================================
-- ВАЖНО: Этот запрос нужно выполнить с правами администратора БД
-- Если не работает, попросите хостинг увеличить через панель управления
SET GLOBAL max_allowed_packet = 16777216; -- 16MB

-- Проверка текущего значения (должно быть 16777216 или больше)
SHOW VARIABLES LIKE 'max_allowed_packet';

-- ============================================
-- ШАГ 2: Очистить старые записи из wffilemods
-- ============================================
-- ВАЖНО: Замените wp_wffilemods на ваше реальное имя таблицы!
-- Удаляем записи старше 30 дней (это освободит место и ускорит сканирование)
DELETE FROM wp_wffilemods 
WHERE mtime < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY));

-- Проверка количества записей после очистки
SELECT COUNT(*) as total_records FROM wp_wffilemods;

-- ============================================
-- ШАГ 3: Оптимизировать таблицу
-- ============================================
-- Это улучшит производительность
OPTIMIZE TABLE wp_wffilemods;

-- ============================================
-- ШАГ 4: Проверить структуру таблицы
-- ============================================
-- Убедитесь, что поля имеют достаточный размер
DESCRIBE wp_wffilemods;

-- Если поля filename или real_path слишком короткие (меньше 1000 символов),
-- выполните следующие запросы (раскомментируйте при необходимости):

-- ALTER TABLE wp_wffilemods MODIFY filename VARCHAR(1000) NOT NULL;
-- ALTER TABLE wp_wffilemods MODIFY real_path VARCHAR(1000) NOT NULL;

-- ============================================
-- ШАГ 5: Проверить индексы
-- ============================================
-- Индексы ускоряют поиск и вставку данных
SHOW INDEXES FROM wp_wffilemods;

-- Если индексов нет или их мало, можно добавить (раскомментируйте при необходимости):

-- CREATE INDEX idx_filenameMD5 ON wp_wffilemods(filenameMD5);
-- CREATE INDEX idx_mtime ON wp_wffilemods(mtime);
