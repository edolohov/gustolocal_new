# Защита WordPress от брутфорс-атак и спама сброса паролей

## Проблема
На сайт `gustolocal.es` происходят брутфорс-атаки:
- Ночью приходит 20+ писем о сбросе пароля
- После атак пользователи не могут войти под своим паролем
- Атаки направлены на всех пользователей (включая администраторов)

## Реализованные решения

### 1. Защита от брутфорс-атак (добавлено в `functions.php`)

**Класс `WordPress_BruteForce_Protection`:**
- Ограничивает количество неудачных попыток входа с одного IP: **5 попыток**
- Блокирует IP на **1 час** после превышения лимита
- Автоматически очищает счетчик при успешном входе
- Логирует все подозрительные попытки

**Как работает:**
1. При каждой неудачной попытке входа счетчик увеличивается
2. После 5 неудачных попыток IP блокируется на 1 час
3. При успешном входе счетчик сбрасывается
4. Все события логируются в `error_log`

### 2. Ограничение запросов на сброс пароля

- Максимум **3 запроса на сброс пароля** с одного IP в час
- При превышении лимита запрос блокируется с сообщением об ошибке
- Логируются все попытки с указанием IP и имени пользователя

### 3. Отключение уведомлений о сбросе пароля для администраторов

**ВАЖНО:** Это не блокирует сам процесс сброса пароля, а только отключает отправку писем администраторам.

**Почему это безопасно:**
- Администратор может сбросить пароль через админку WordPress
- Обычные пользователи (клиенты) продолжают получать письма о сбросе пароля
- Это предотвращает спам-атаки на администраторов

### 4. Блокировка подозрительных IP адресов

**Текущий список заблокированных IP:**
- `196.251.88.101` (из вашего письма)

**Как добавить новые IP:**
Откройте `functions.php` и найдите функцию `block_suspicious_ips()`:

```php
$blocked_ips = array(
    '196.251.88.101', // IP из вашего письма
    '123.456.789.0',  // Добавьте новый IP здесь
);
```

### 5. Логирование всех попыток

Все подозрительные действия логируются в `error_log` WordPress:
- Неудачные попытки входа
- Запросы на сброс пароля
- Попытки доступа с заблокированных IP
- Попытки сброса пароля для несуществующих пользователей

**Где найти логи:**
- Через панель хостинга: обычно в `/logs/error_log` или `/logs/php_error.log`
- Через SSH: `/var/log/apache2/error.log` или `/var/log/php-fpm/error.log`
- В WordPress: через плагин для просмотра логов (например, WP Activity Log)

## Дополнительная защита через .htaccess

### Rate Limiting для wp-login.php

Добавьте в `.htaccess` в корне WordPress (после существующих правил):

```apache
# Защита от брутфорс-атак на wp-login.php
<FilesMatch "^(wp-login\.php|wp-admin)">
    # Ограничение: максимум 5 запросов в минуту с одного IP
    <IfModule mod_evasive.c>
        DOSHashTableSize    2048
        DOSPageCount        5
        DOSSiteCount        50
        DOSPageInterval     1
        DOSSiteInterval     1
        DOSBlockingPeriod   3600
    </IfModule>
</FilesMatch>

# Блокировка подозрительных IP (если есть доступ к конфигурации Apache)
# <RequireAll>
#     Require all granted
#     Require not ip 196.251.88.101
# </RequireAll>
```

### Альтернатива: Rate Limiting через .htaccess (без mod_evasive)

Если модуль `mod_evasive` не установлен, можно использовать:

```apache
# Защита wp-login.php от брутфорс-атак
<FilesMatch "wp-login\.php">
    # Ограничение частоты запросов
    # Можно добавить проверку через mod_rewrite
    # Но лучше использовать PHP-защиту (уже реализована)
</FilesMatch>
```

## Настройка защиты

### Изменить лимиты попыток входа

В `functions.php` найдите класс `WordPress_BruteForce_Protection` и измените:

```php
private $max_attempts = 5; // Измените на нужное число
private $lockout_time = 3600; // Измените на нужное время в секундах (3600 = 1 час)
```

### Изменить лимит запросов на сброс пароля

В методе `check_password_reset_limit()`:

```php
// Максимум 3 запроса на сброс пароля с одного IP в час
if ($attempts >= 3) { // Измените на нужное число
    // ...
}
```

## Рекомендации для дополнительной защиты

### 1. Установить плагин безопасности

Рекомендуемые плагины:
- **Wordfence Security** - комплексная защита, включая брутфорс-защиту
- **iThemes Security** - альтернатива Wordfence
- **Limit Login Attempts Reloaded** - специализированный плагин для защиты от брутфорс-атак

**ВАЖНО:** Если установите плагин, убедитесь, что он не конфликтует с нашей защитой. Можно отключить нашу защиту или настроить плагин так, чтобы он использовал наши настройки.

### 2. Изменить URL страницы входа

Можно использовать плагин **WPS Hide Login** или добавить в `functions.php`:

```php
// Изменить URL wp-login.php на /secret-login/
add_action('login_init', function() {
    if (strpos($_SERVER['REQUEST_URI'], '/wp-login.php') !== false) {
        wp_redirect(home_url('/secret-login/'));
        exit;
    }
});
```

### 3. Добавить CAPTCHA на страницу входа

Рекомендуемые плагины:
- **reCAPTCHA by BestWebSoft**
- **Google reCAPTCHA v3 for Contact Form 7**

### 4. Двухфакторная аутентификация (2FA)

Рекомендуемые плагины:
- **Two Factor Authentication**
- **Wordfence Login Security** (входит в Wordfence)

### 5. Мониторинг и алерты

Настройте уведомления о подозрительной активности:
- Email-уведомления при блокировке IP
- Уведомления при множественных попытках сброса пароля
- Ежедневные отчеты о безопасности

## Проверка работы защиты

### Тестирование защиты от брутфорс-атак:

1. Попробуйте войти с неправильным паролем 5 раз подряд
2. На 6-й попытке вы должны увидеть сообщение: "Слишком много неудачных попыток входа"
3. Проверьте логи - должны быть записи о блокировке

### Тестирование защиты от спама сброса пароля:

1. Запросите сброс пароля 3 раза подряд
2. На 4-й попытке запрос должен быть заблокирован
3. Проверьте логи - должны быть записи о попытках

### Проверка отключения писем администраторам:

1. Попросите кого-то запросить сброс пароля для вашего администраторского аккаунта
2. Вы НЕ должны получить письмо
3. В логах должна быть запись: "письмо НЕ отправлено"

## Мониторинг атак

### Как найти IP атакующих в логах:

```bash
# Через SSH
grep "WordPress Security" /var/log/apache2/error.log | tail -50

# Или через панель хостинга
# Откройте error_log и найдите строки с "WordPress Security"
```

### Типичные записи в логах:

```
WordPress Security: IP 196.251.88.101 заблокирован после 5 неудачных попыток входа для пользователя admin
WordPress Security: Запрос на сброс пароля для пользователя "admin" с IP 196.251.88.101
WordPress Security: Попытка сброса пароля для администратора admin с IP 196.251.88.101 - письмо НЕ отправлено
WordPress Security: ВНИМАНИЕ! Попытка сброса пароля для НЕСУЩЕСТВУЮЩЕГО пользователя "hacker" с IP 196.251.88.101
```

## Что делать при обнаружении атаки

1. **Проверьте логи** - найдите IP адреса атакующих
2. **Добавьте IP в черный список** - в функцию `block_suspicious_ips()`
3. **Проверьте, не скомпрометирован ли аккаунт** - сбросьте пароль администратора
4. **Уведомите хостинг-провайдера** - они могут заблокировать IP на уровне сервера
5. **Установите дополнительные плагины безопасности** (см. рекомендации выше)

## Важные замечания

1. **Не отключайте защиту** даже если она работает - атаки могут возобновиться
2. **Регулярно проверяйте логи** - это поможет выявить новые атаки
3. **Обновляйте WordPress и плагины** - устаревшие версии уязвимы
4. **Используйте сильные пароли** - минимум 16 символов, буквы, цифры, символы
5. **Не используйте стандартные имена пользователей** - `admin`, `administrator` легко угадать

## Отключение защиты (если нужно)

Если вы установили плагин безопасности, который дублирует функционал, можно отключить нашу защиту:

```php
// В functions.php закомментируйте или удалите:
// new WordPress_BruteForce_Protection();
```

Или удалите весь блок кода защиты (строки с комментарием "ЗАЩИТА ОТ БРУТФОРС-АТАК").




