#!/bin/bash
# –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (git tag)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/load-env.sh"

cd "$PROJECT_ROOT"

if [ -z "$1" ]; then
    echo "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–µ–≥ –¥–ª—è –æ—Ç–∫–∞—Ç–∞"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <tag-name>"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏:"
    git tag -l
    exit 1
fi

TAG_NAME="$1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–≥
if ! git tag -l | grep -q "^${TAG_NAME}$"; then
    echo "‚ùå –¢–µ–≥ '$TAG_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏:"
    git tag -l
    exit 1
fi

echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ –≤–µ—Ä—Å–∏–∏ '$TAG_NAME'"
echo "   –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "‚ùå –û—Ç–∫–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω"
    exit 0
fi

echo "üîÑ –û—Ç–∫–∞—Ç—ã–≤–∞—é—Å—å –∫ —Ç–µ–≥—É: $TAG_NAME"
git checkout "$TAG_NAME"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ"
    exit 1
fi

echo "üì¶ –î–µ–ø–ª–æ—é –æ—Ç–∫–∞—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω..."
./scripts/deploy-to-prod.sh

if [ $? -eq 0 ]; then
    echo "‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –í—ã —Å–µ–π—á–∞—Å –Ω–∞ —Ç–µ–≥–µ $TAG_NAME"
    echo "   –ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   git checkout main"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ"
    exit 1
fi

